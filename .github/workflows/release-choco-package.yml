name: Release Chocolatey Package

on:
  push:
    branches:
      - master

env:
  CHOCO_PACKAGE_NAME: velero
  # publish packages to this url
  NUGET_SOURCE: https://push.chocolatey.org/

jobs:
  release-choco-package:
    # https://github.com/actions/virtual-environments
    runs-on: windows-2019
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Create NuGet Package
        run: choco pack -y

      - name: Test NuGet Package
        env:
          CHOCO_PACKAGE_NAME: ${{ env.CHOCO_PACKAGE_NAME }}
        run: ./test.ps1

      - name: Publish NuGet Package
        run: |
          # get version
          [xml]$spec = Get-Content ${{ env.CHOCO_PACKAGE_NAME }}.nuspec
          $version = $spec.package.metadata.version

          # set api key
          choco apikey --key ${{ secrets.CHOCOLATEY_API_KEY }} --source ${{ env.NUGET_SOURCE }}

          # push package
          Write-Output "Pushing version [$version] to [${{ env.NUGET_SOURCE }}]..."
          # choco push -y ${{ env.CHOCO_PACKAGE_NAME }}.$($version).nupkg --source ${{ env.NUGET_SOURCE }}
